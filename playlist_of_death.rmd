---
title: "Playlist of Death"
output: html_notebook
---

Can we determine musician mortality rates by analyzing WFMU radio playlists?


#Load Required Libraries and Data
```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(stringr)
library(tidyverse)
library(lubridate)
library(knitr)
library(xts)
library(tsoutliers)

load("playlists.rdata")
```
#The Data Set

Free form radio, WFMU.ORG, maintains a huge trove of past playlists from many DJ's radio shows.  More recently, web-only programming has been added to this.  This data set offers lots of opportunities for analysis.  I scraped all the playlists I could from the web site and started asking questions (after I got permission to scrape from station manager, Ken Freedman).  While not qualifying as "big data," the data set is pretty extensive. Let's look as some summary stats.

```{r, warning=FALSE}
year_count<-playlists %>% 
  ungroup() %>% 
  transmute(Year_count=year(AirDate)) %>% 
  distinct() %>% nrow()
dj_count<-playlists %>% group_by(DJ) %>% summarise(DJs=n()) %>% nrow #DJs
show_count<-playlists %>% group_by(DJ,AirDate) %>% summarise(Shows=n()) %>% nrow()
#Artists
artist_count<-playlists %>% ungroup() %>% select(ArtistToken) %>% distinct() %>% nrow()

#songs
song_count<-playlists %>% ungroup() %>% select(ArtistToken,Title) %>% distinct() %>% nrow()

spins_count<-nrow(playlists) # spins

the_numbers<-data_frame(
           Count=c(year_count,dj_count,show_count,artist_count,song_count,spins_count),
           Stat=c("Years","DJs","Shows","Artists","Songs","Spins"))

the_numbers %>% 
  kable(caption="WFMU Archives by the Numbers",
        col.names=c('WFMU',' Archives by the Numbers'),
        format.args = list(big.mark=","))
```


You can see the ultimate result of my work at the [WFMU Playlist Explorer](wfmu.servebeer.com), a fun toy, if I do say so.

#Morbid Thoughts

When playing around with the artist data for "Prince" I noticed a spike in plays around his death.  
```{r}
#few playlists before 2002
cutoff_date<-as.Date("2002-01-01")
dead_artist_plays<-playlists %>% 
  ungroup() %>% 
  filter(AirDate > cutoff_date) %>% 
  filter(ArtistToken=="Prince") %>% 
  mutate(AirDate=as.yearqtr(AirDate)) %>% 
  group_by(AirDate) %>% 
  summarise(Spins=n()) %>% 
  arrange(AirDate)
gg<-dead_artist_plays %>% ggplot(aes(x=AirDate,y=Spins))+geom_col()
gg<-gg+scale_x_continuous()
gg<-gg+labs(y="Spins per Quarter",title="Dead Artist Effect: Prince")
gg

```

WFMU is a "free form" station where DJs play what they like, so this is not a surprise. This got me to thinking, can we use the data set to tell us who died and when?

This is still "small data" in the scheme of things.  Plenty of song plays but not plenty of artists who died and who are popular with the DJs at the station.  So, this won't be an exercise in machine learning as we don't have a robust training set.  Still, as we saw with the Prince data the mortality, the spike is quite the outlier.  Maybe we can simply calibrate a number that gives us a high accuracy rate and discover some deaths that don't immediately come to mind.  The recenly departed that immediately pop into my head are Prince, Bowie, Chuck Barry and one less famous artist, Leslie Gore.  How do they look?

We're going to be running this chart a lot so let's make a function.
```{r}

gg_play_freq<-function(artists,cutoff_date=Sys.Date()-(365*5)){
  artist_plays<-playlists %>% 
    ungroup() %>% 
    filter(AirDate > cutoff_date) %>% 
    filter(ArtistToken %in% artists) %>% 
    mutate(AirDate=as.yearqtr(AirDate))  %>% 
    group_by(DJ,ArtistToken,AirDate) %>% 
    summarise(Spins=n()) %>% 
    arrange(AirDate)
  gg<-artist_plays %>% ggplot(aes(x=AirDate,y=Spins))
  gg<-gg+geom_col()+facet_wrap(~ArtistToken) 
  gg<-gg+scale_x_continuous(breaks=seq(year(cutoff_date),year(Sys.Date()),by=2))
  gg<-gg+ggtitle("Dead Artist Effect")
  gg
  
}

cutoff_date<-as.Date("2008-01-01")
dead_artists=c('Bowie','Prince','ChuckBerry','LesleyGore')
gg_play_freq(dead_artists,cutoff_date)
```

Yes, I think we are onto something.  We need to do some outlier detection. The question is what is a suitable filter to determine probable mortality.  One simple way might be to simply look at the play count in a quarter as a multiple of the average and select everything above a certain multiple.

Z-score is what I often use to look at anomalous movements in financial markets.  This is the number of standard deviations from the mean. It is a little superior to the first method as is scales the outline by how much beyond the normal variability it is.

We could use more formal statistical methods of of outlier detection. One might be to use a linear model to detrend the data before looking at a z-score.  The rising number of DJs posting playlists over time means there is trend growth for most artists. Visually,though, we see the spikes in plays are so extreme they reduce the trend to irrelevance.  We could also use autoreggresive moving average (ARIMA) techniques. This is common to detect outliers in time series.  I will not be exploring these for two reasons.  The series of play counts we are looking at are reasonably stationary.  Our simple techniques do a good job highlighting the spikes.  The other is computing time.  Running an outlier detection package like `tsoutlier` does a good job but no better than our simple tools and is much, much slower.  Hand grenade when a fly swatter works and all that.  Still, it prompted me to learn how to use the package so WIN!

Three artists shown above are (were) superstars so I would guess their spikes were extreme.  I wouldn't expect more obscure artists, like Lesley Gore to be picked up by a wide swath of the DJ population.  Let's experiment with different screen levels.

First let's bucket all the artist plays by quarter, find the mean number of plays, the multiple and the z-score.  Then keep just the maximum z_score period for each artist.


```{r}
play_count<-playlists %>% 
  ungroup() %>% 
  mutate(AirDate=as.yearqtr(AirDate))  %>% 
  group_by(ArtistToken,AirDate) %>% 
  summarise(Spins=n()) %>% 
  mutate(avg=mean(Spins),sd=sd(Spins)) %>% 
  filter(!is.na(sd)) %>% 
  mutate(z_score=(Spins-avg)/sd) %>% 
  mutate(multiple=Spins/avg) %>% 
  filter(!is.na(multiple)) %>% 
  filter(!is.na(z_score))

play_count_z<- play_count %>% 
  group_by(ArtistToken) %>% 
  summarize(z_score=max(z_score)) %>% 
  left_join(play_count)

rm(play_count) #This is a 400 thousand-long table that we don't need any more.
head(play_count_z)
```

We have compared the number of spins each quarter to the average spins per quarter and computed the z-score as `(Spins-avg)/sd`.   How do we screen for deaths? What z-scores and multiples did the artists we listed above show at their extremes?

```{r}
play_count_z %>% 
  filter(ArtistToken %in% dead_artists)
```

<<<<<<< HEAD
So a z-score of 6.5 might be a good screen level.
=======
So is a z-score of seven a good screen level? How about 6, just to be safe?
>>>>>>> cf9258cb6365f142953d53f6ecd82dfc578c7ab7
```{r}
play_count_z %>% 
  filter(z_score>6.5)

```
<<<<<<< HEAD
The weakness in this approach is our threshhold captures a lot of bands/artists where there was no mortality event. ELO, The Dictators, The Clash, etc. The false postive rate is pretty high. Further, the threshold to use for z-scores to use is not obvious. There are no obvious outliers of outliers.
=======
93? That is too many,me thinks
>>>>>>> cf9258cb6365f142953d53f6ecd82dfc578c7ab7

```{r}
cutoff_date<-as.Date("2001-01-01")
not_dead_artists<-c("Elo","Dictators","Residents")

gg_play_freq(not_dead_artists,cutoff_date)

```


What about false negatives.  As we lower the threshold for detection the list grows pretty big.  Do you see any mortality events in the next 1 point of z-scores?

```{r}
play_count_z %>% 
  filter(z_score<6.5 ) %>% 
  filter(z_score>5.5 ) %>% 
  filter(ArtistToken=)
```
Alas, yes. The Band (Levon Helm), Bobby Womack and Etta James are the ones I found right away.  Bjork is not dead yet.

```{r}
cutoff_date<-as.Date("2001-01-01")
artists<-c("Band","BobbyWomack","EttaJames","Bjork")
gg_play_freq(artists,cutoff_date)

```

What might we do to improve this?

One thing to note is the banal observation that there might be reasons for a flurry of plays by an artist for other reasons than mortality.  A new album, a performance in town, a band member is in the news beacause of some outrageous behavior, etc.  A Google search for news around that time might reveal the answer but an algorithmic approach to that is outside the scope of this post.

Another thought is that invididual DJs might feature a particular artist on one show and that spikes the play count.  Compare that to a mortality event where we assume many DJs play the artist's music in the wake of the news.  Let's look at the dispersion of DJ's playing an artists music around play count spikes.  In the chart below each color represents a different DJ.

```{r}
gg_play_freq_dj<-function(artists,cutoff_date=Sys.Date()-(365*5)){
artist_plays<-playlists %>% 
    ungroup() %>% 
    filter(AirDate > cutoff_date) %>% 
    filter(ArtistToken %in% artists) %>% 
    mutate(AirDate=as.yearqtr(AirDate))  %>% 
    group_by(DJ,ArtistToken,AirDate) %>% 
    summarise(Spins=n()) %>% 
    arrange(AirDate)
  gg<-artist_plays %>% ggplot(aes(x=AirDate,y=Spins,fill=DJ))
  gg<-gg+geom_col()+facet_wrap(~ArtistToken) 
  gg<-gg+scale_x_continuous(breaks=seq(year(cutoff_date),year(Sys.Date()),by=2))
  gg<-gg+ggtitle("Dead Artist Effect")+theme(legend.position = "none")
  gg
}  

dead_artists %>% gg_play_freq_dj()
```
Now let's look at our not dead artists.
```{r}
cutoff_date<-(as.Date("2002-01-01"))
not_dead_artists<-c(not_dead_artists,"Bjork")
not_dead_artists %>% gg_play_freq_dj(cutoff_date)
```
Huzzah!  In every mortality case a diverse group of DJs played the artist and in every not-dead case one DJ amounted to the lion's share of plays.  

The Dictators are a less clear example, showing huge spike by many DJs in the fall of 2007 with no deaths.  This is an example of a new album release spike.  "Every Day is Saturday" is a collection of Dictators rarities officially released in January of 2008.  The 'Tators are a NYC favorite and I assume WFMU got an early copy. These cases are going to slip through our screens and produce false positives.

Let's rebuild and add a feature to our data set that includes the number of DJs who played the artist in any quarter.
```{r}
dj_count<-playlists %>% 
  ungroup() %>% 
  mutate(AirDate=as.yearqtr(AirDate))  %>% 
  group_by(ArtistToken,AirDate,DJ) %>% 
  summarise(Spins=n()) %>% 
  summarise(DJ_count=n())

play_count_z2<- play_count_z %>% 
  select(ArtistToken,AirDate,z_score) %>% 
  left_join(dj_count)

head(play_count_z2)
```
Now we have to find the right mix of z_score and dj_count that gives us the best trade-off of detected deaths without false positives.  What does the distribution of DJ counts look like at the max z-score points?
```{r}
play_count_z2 %>%
  filter(DJ_count<12) %>% 
  ggplot(aes(DJ_count))+geom_histogram(bins=12)
  
```

There is a sharp break between two and three. Let's make greater than two DJs playing the artist and a z-score above 6 the cuts.  We loosen the z-score criteria and hope that our new DJ count feature will help.
```{r}
play_count_z2 %>% filter(z_score>6,DJ_count>2)
```

We still see, Bjork, ELO and Buddy Holly on this list.  Holly died, of course, but outside of the timeframe of our analysis.  Bobby Womack died but only 5 DJs played him.  Let's try looking at DJ play counts above the average for the artist.
```{r}
play_count_z2 %>% filter(z_score>6)
```
