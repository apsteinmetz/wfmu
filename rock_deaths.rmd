---
title: "Summarizing Deaths in Rock"
output: html_notebook
---
Live fast, die young, stay pretty.  That's the stereotype for rockers, or it was.  We only need to look at Keith Richards, over 70 and going strong, to find a major counterexample.  Do rockers die young?  What do they die of?  We can use Wikipedia and [this page.](https://en.wikipedia.org/wiki/List_of_deaths_in_rock_and_roll) to make some generalizations.

We will scrape the tables and do sum summary aggregations.  R and the xml2 package have some great functions for converting html `<table>`s into data frames.

The deaths for 2010 and later are in a separate article so we need to get both.  When I started this project they were on one page. By the time you read this the Wikipedia gods may have changed it again.  Beware.
```{r message=FALSE, warning=FALSE}
library(XML)
library(xml2)
library(ggplot2)
library(stringr)
library(tidyverse)
library(lubridate)
library(knitr)
library(xts)
library(rvest)
library(ggrepel)
library(gapminder)

# function to mutate only rows meeting a certain condition
#most useful enhancement to dplyr ever!
#I load this in all my projects.
mutate_cond <- function(.data, condition, ..., envir = parent.frame()) {
  condition <- eval(substitute(condition), .data, envir)
  condition[is.na(condition)] = FALSE
  .data[condition, ] <- .data[condition, ] %>% mutate(...)
  .data
}

death_page1<-read_html("https://en.wikipedia.org/wiki/List_of_deaths_in_rock_and_roll")
write_html(death_page1,file="death_page1.html")
death_page2<-read_html("https://en.wikipedia.org/wiki/List_of_2010s_deaths_in_rock_and_roll")
write_html(death_page2,file="death_page2.html")

```
`xml2` is a very powerful package but one thing I learned is that it works with pointers to the data rather than the actual data. C programmers and old geezers like me will be familiar with this.  I remember pop and push and stacks and all that stuff from the old days.  R generally doesnt pass values "by reference." It passes "by value." That's why when you modify data in the scope of a function it doesn't affect the value of the data outside unless you assign it with `return <data>`.  Using pointers means modifications to html data happen without an explicit assigment.

Consider a trival example:
```{r, eval=FALSE}
#ususal R behavior
my_function<- function(x){return (x+1)}
data=3
#this doesn't change data
my_function(data)
data
#[1] 3
#this does
data<-my_function(data)
data
#[1] 4
```
If we were passing values "by reference" `my_function(data)` would change `data`.  That's how `xml2` works.

We use this behaviour to combine them the tables in the two Wikipedia articles into one html page by extracting the tables in the second wiki article and making them xml siblings of the tables in the first.
```{r}
#join pre-2010 to post 2010
death_page<-death_page1
death_page_child<-death_page1 %>% xml_children() %>% .[2]
death_page2_child<-death_page2 %>% xml_children() %>% .[2]
#create one big web page by adding all the first level children from the second
#page to the first.
xml_add_sibling(death_page_child,death_page2_child)
write_html(death_page,file="death_page.html")

```
Unfortunately, as is often the case, the tables are not as clean as we might like. 

Here's a data wrastlin' puzzle.  The artist and the band name or names share a single cell.  This is not a problem for the anonymous summary stats we will present here but I am doing another analysis where I look at radio station playlist patterns do detect deaths.  Here we need to flag the event by band or artist, however it appears.

Parsing HTML is a dark art and I would not rise to the level of sorcerer's apprentice.  The clue that will let us separate the two (or more) identifiers is that the band is encased in a `<small><\small>` tag.  Extracting the just the text from the cell concatenates the two items without a separator.  The `XML2` functions won't help this noob here.  We would like to break the person and the band into separate columns and we need to search/replace the file as raw text to do it. So instead of `<td>Person<small>Band,Band<\small><\td>` we want to have `<td>Person,Band,band<\td>`.  This way we can separate out band names later.


```{r}
#Crude hack follows
# read it in as a raw text file and edit the tags
# to break the artist name and band names into comma-separated list
# by replacing '<small>' with ','.
death_page_text<-read_file("death_page.html")
death_page_text<- gsub( "<small>", ", ", death_page_text )
death_page_text<- gsub( "</small>", "", death_page_text )
write_file(death_page_text,"death_page2.html")

```
A further wrinkle is some of the age-at-death numbers are given as a range like "45-46" which causes `html_table` to create a `character  ` column while it will othwise be of type `numeric`.  We want to use `bind_rows` to combine all the web page tables into one data frame but it will break on the type conflict.  Let's arbitrarily take the lowest number in age range before binding.  We can do this as part of the table extraction process.

```{r}
# omit first five tables
deaths_raw<-read_html("death_page2.html") %>% 
  html_nodes("table") %>% 
  .[5:length(.)] %>% 
  html_table(fill=TRUE) %>%
  lapply(function(x){mutate(x,Age=as.integer(str_extract(as.character(Age),"[0-9]+")))}) %>% 
  bind_rows() %>% 
  as_data_frame() %>% 
  {.}

deaths_raw
```


Almost done.  Separate out the list of name and bands into, at most, four bands. Turn the date string into a POSIX-style date. Replace the empty causes with "Not Specified." Finally, strip the footnote numbers out of the file.

```{r warning=FALSE}
#take at most three band names.
deaths<-deaths_raw %>% 
  separate(Name,into=c("Name","band1","band2","band3","band4"),sep=",",extra="drop")

deaths<-deaths %>% 
  mutate(Date=parse_date(Date,"%B %d, %Y")) %>% 
  filter(!is.na(Date))

#remove footnotes and change empty causes to "Not Specified"

deaths<-deaths %>% mutate(`Cause of death`=str_replace(`Cause of death`,"\\[[0-9,]+\\]",""))
deaths<-deaths %>% mutate_cond(is.na(`Cause of death`),`Cause of death`="Not Specified")
deaths<-deaths %>% mutate_cond(`Cause of death`=="",`Cause of death`="Not Specified")
```
#Number of reports

Now we have a clean table.  Before going further we should note that reports are growing over time.  No great surprises here but this says something about the age of Wikipedia, the grownig popularity of Wikipedia and the age of Rock and Roll.  It does not say anything about the business getting more risky.

```{r}
deaths<-deaths %>% mutate(Year=year(Date))

deaths %>%  
  group_by(Year) %>% 
  summarise(NumEntries=n()) %>%
  ggplot(aes(Year,NumEntries))+geom_col()

```
# Common causes of Death

```{r}
#what are common causes of death
cause_table<-deaths %>% 
  group_by(`Cause of death`) %>% 
  summarize(Cause=n()) %>% 
  arrange(desc(Cause))

cause_table
```
Looking through the table we see that many causes can be generalized.  Let's aggregate a bit. We are making some choices here.  For instance, I call any cause containing the words "heart" or "cardiac" as "heart disease."  I count alcohol as a drug.
```{r}
#add a new column "general cause"
deaths<-deaths %>% mutate(General_Cause=`Cause of death`)

deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "accident|fall|hit|crash"),General_Cause="Accident")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "drug|overdose|alcohol"),General_Cause="Drugs")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),"asphyxiation"),
              General_Cause="Asphyxiation")

deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),"shot|shoot|murder|stab|gun|knife"),
              General_Cause="Murdered")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "heart|cardi|coronary"),General_Cause="Heart Disease")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),"aids|hiv"),General_Cause="AIDS")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "diabetes|diabetic"),General_Cause="Diabetes")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "pneumonia|emphysema"),General_Cause="Lung Disease")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "cirrhosis|neph|liver"),General_Cause="Liver Disease")

deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "stroke"),General_Cause="Stroke")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "alzh"),General_Cause="Alzheimers")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),"suicide"),General_Cause="Suicide")

#Cancer is last because iting other organs and cancer counts as cancer.
#-omas other than "stomach" and "coma" are cancer
deaths<-deaths %>% 
  mutate_cond(str_detect(`Cause of death`,"oma") & 
                !str_detect(`Cause of death`,"tomach|coma"),
              General_Cause="Cancer")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),"cancer|tumor"),General_Cause="Cancer")

cause_table<-deaths %>% 
  count(General_Cause) %>% 
  arrange(desc(n)) %>% 
  rename(Rockers=n)

cause_table<-cause_table %>% mutate(General_Cause= as_factor(General_Cause))
cause_table
```

```{r}
#plot, leaving out "not specified"
gg<-cause_table[1:11,]  %>% 
  filter(General_Cause != "Not Specified") %>%
  ggplot(aes(General_Cause,Rockers))+geom_col()
gg<-gg+coord_flip()
gg
```
Now we have a decent picture of how rock stars die.  Mostly from the same things that kill all of us. Heart disease and Cancer are the leading causes of death in US, followed by lung disease and accidents according to https://www.cdc.gov/nchs/fastats/deaths.htm.

Heart disease: 633,842
Cancer: 595,930
Chronic lower respiratory diseases: 155,041
Accidents (unintentional injuries): 146,571
Stroke (cerebrovascular diseases): 140,323
Alzheimerâ€™s disease: 110,561
Diabetes: 79,535
Influenza and Pneumonia: 57,062
Liver disease: 49,959
Suicide: 44,193
Murder: 15,696 (https://ucr.fbi.gov/crime-in-the-u.s/2015/crime-in-the-u.s.-2015/tables/table-4)
Drug overdoses: 53,000 (2015,https://www.drugabuse.gov/related-topics/trends-statistics/overdose-death-rates)
Alcohol Poisoning:2,200 (https://www.cdc.gov/vitalsigns/alcohol-poisoning-deaths/index.html)

A couple things to note. Drug overdoses may count as "accidents" at the CDC.  I don't separate out Pneumonia from chronic lung problems. Alzheimer's is a big killer, nationally but is only 21st on the list of rock deaths.  Perhaps it is underreported or was recognized as a distinct cause of death only recently.

There are some interesting causes in this list.  Three electrocutions, two by guitar and one my microphone. They all happened in England in the early 70s.  Presumably the electrical codes have been tightned up a bit since.  Three people are listed who choked on their own vomit. That's all? Consider the hapless Steve Took of T Rex, who died from choking on a cocktail cherry.  That's why I always take my Manhattans with a lemon twist instead.

While the big killers are the same for both populations, is there evidence that rockers "live fast?"  Yes, it turns out.

```{r}

us_deaths<-data_frame(General_Cause=as_factor(c('Heart Disease','Cancer',
                                      'Lung Disease','Accident','Stroke',
                                      'Alzheimers','Diabetes','Liver Disease',
                                      'Suicide','Murdered')),
                      US=c(633842,595930,212103,146571,140323,110561,79535,49959,44193,15696))

# we assume the CDC calls drug overdoses an accident so we will too.
comp_deaths<-cause_table %>% 
  mutate_cond(General_Cause=="Drugs",General_Cause="Accident") %>% 
  group_by(General_Cause) %>% 
  summarise(Rockers=sum(Rockers)) %>% 
  right_join(us_deaths) %>%
  mutate(General_Cause=as_factor(General_Cause)) %>% 
  mutate(Rockers=Rockers/sum(Rockers),US=US/sum(US))
  

gg<-comp_deaths %>% ggplot(aes(US,Rockers))+geom_point()
gg<-gg+  geom_text_repel(label=comp_deaths$General_Cause)
gg<-gg+geom_abline(slope=1,intercept=0)
gg<-gg+labs(title="Rock Stars are (Almost) Like the Rest of US\nProportion of all Deaths",caption="Sources: Wikipedia and CDC",
y='Rock Music Deaths (1950-Present)',x='US Deaths (2015)')
gg<-gg+scale_x_continuous(labels=scales::percent)
gg<-gg+scale_y_continuous(labels=scales::percent)
gg
```
This shows the preponderance of Rock musician deaths relative to the broader US population.  We can see that suicide, murder and, especially, accidents account for more relative deaths than they do in the broader population.

We've <grin>scientifically proven</grin> that rock stars "live fast."  Do they die young?  Life expectancies have grown over the years so taking an aggregate average age at death won't be comprable to current US life expectancy.  To get a comparison let's pull the data from the `gapminder` package.  This shows life expectancy at birth as opposed to average age at death, which is what we have now, so we have to get a bit tricky to make the numbers comparable.  Our year at births is much earlier than the gapminder set covers so we need to extrapolate the data, as well.

```{r}
#Add birth year column.
deaths<-deaths %>% mutate(birth_year=year(Date)-Age)

#Create extrapolation of gapminder life expectancy using the full range of birth
#years from the deaths table.
life_exp<-gapminder %>% 
  filter(country=="United States") %>% 
  select(year,lifeExp) %>% rename(birth_year=year) %>% 
  complete(birth_year=min(deaths$birth_year):year(Sys.Date())) %>% 
  {.}
p<-lm(life_exp$lifeExp~life_exp$birth_year)
life_exp$US<-predict(p,life_exp)

#how well does this fit the data?
life_exp %>% ggplot(aes(birth_year,US))+geom_line()+geom_point(aes(y=lifeExp))+
  labs(title="Gapminder US Data:Extrapolated Life Expectancy at Birth",y="Life Expectancy",x="Birth Year")

```
We see that the `gapminder` data is pretty linear so we should be okay to extrapolate.  That said, we are going way beyond the observed range.  Our sample sizes are pretty small at the far end of the range, anyway, so any conclusions would have to be taken with a huge grain of salt,regardless.  Still, lets plunge on!

We need to apply the expected longevity for each musician for the year they were born and compare that to the age they were at death.  We then summarize that data for each year of deaths.  To put it another way, in any given year, did the rock musicians who died compare to the life expectancy for all people born in the US the same year each rock musician did.
```{r}
#merge deaths with life expectancy for the relevant birth year.  Determine
#whether they died "young"  or outlived expectations.
deaths <- deaths %>% 
  left_join(life_exp) %>% 
  select(-lifeExp) %>% 
  mutate(relative_mortality=Age-US) %>% 
  rename(expected_longevity=US) %>% 
  {.}

death_age<-deaths %>% 
  group_by(Year) %>% 
  summarise(rock_mean=as.integer(mean(Age)),
            us_mean=mean(expected_longevity),
            relative_mortality=mean(relative_mortality))

gg<-death_age %>% ggplot(aes(Year,rock_mean,color="red"))+geom_line()
gg<-gg+geom_line(aes(y=us_mean,color="black"))
gg<-gg+geom_col(aes(y=relative_mortality,fill="darkgrey"),color="lightgrey")
gg<-gg+labs(title="Rock Stars Don't Die Young Anymore\nRocker Death Age vs. U.S. Population",
            y="Average Age At Death",
            x="Year of Death",
            caption="Source:Wikipedia, gapminder.org")
gg<-gg+ scale_colour_manual(name = 'Life Exp.', 
         values =c('black'='black','red'='red'), labels = c('US Pop.',"Rockers"))
gg<-gg+ scale_fill_identity(name = 'Gap', guide = 'legend',labels = c(''))
gg
```
This really surprised me.  Rock stars used to die young, but not any more!  They have completely closed the gap with the U.S. population at large (We can discount the early years in this chart since there are so few observations).  Again, Keith Richards, stick with the yoga, dude!

#27

"They" say 27 is particularly risky age to be a rock star.  [The "27 club" is a thing](https://en.wikipedia.org/wiki/27_Club).  Is it truly standout year for mortality, or is it just a meme without grounds?


```{r}
highlight=27

fills<-deaths %>% 
  select(Age) %>%
  unique() %>% 
  arrange(Age) %>% 
  mutate(color="black") %>% 
  mutate_cond(Age==highlight,color="red") %>% 
  pull(color) %>% 
  {.}

gg<-deaths %>% ggplot(aes(Age))+geom_bar(fill=fills)
gg<-gg+labs(title="Rock Musician Age of Death (1950-2017)",y="Count")
gg<-gg+annotate("text",x=27,y=45,label="Age 27",size=8)
gg
```

Well, well, well.  It turns out that 27 IS a risky age! Optically, it looks like about double the mortality we might othwise expect.  We always have to be wary of carts leading horses, though.  Perhaps the folks who are interested in the topic are more than usually dilligent in finding examples and adding them to the Wikipedia page. Still, it's fascinating.  Why do 27-year olds die?  You already know the answer.

```{r}
deaths %>% filter(Age==highlight) %>% 
  group_by(General_Cause) %>% 
  summarise(Count=n()) %>%
  arrange(desc(Count))

```
Tragic, of course.  Those of us who have achieved a certain age occasionally reflect upon all the times in our youth when we did stupid stuff that could have killed us but luck favored us at that moment.  Did I say "we?" Well maybe just me.

#Conclusion

This project started out as part of a separate project but I went down an intersting rabbit hole and realized there was something to say about the Wikipedia data set.  I learned some more tricks about web scraping and found some surprising things in the data.  Win-win!

Stay off the dope, kids!

