---
title: "Summarizing Deaths in Rock"
output: html_notebook
---
Live fast, die young, stay pretty.  That's the stereotype for rockers, or it was.  We only need to look at Keith Richards, over 70 and going strong, to find a major counterexample.  Do rockers die young?  What do they die of?  We can use Wikipedia and [this page.](https://en.wikipedia.org/wiki/List_of_deaths_in_rock_and_roll) to make some generalizations.

We will scrape the tables and do sum summary aggregations.  R and the xml2 package have some great functions for converting html `<table>`s into data frames.

The deaths for 2010 and later are in a separate article so we need to get both.  When I started this project they were on one page. By the time you read this the Wikipedia gods may have changed it again.  Beware.
```{r}
library(XML)
library(xml2)
library(ggplot2)
library(stringr)
library(tidyverse)
library(lubridate)
library(knitr)
library(xts)
library(rvest)
library(ggrepel)
library(gapminder)

# function to mutate only rows meeting a certain condition
#most useful enhancement to dplyr ever!
#I load this in all my projects.
mutate_cond <- function(.data, condition, ..., envir = parent.frame()) {
  condition <- eval(substitute(condition), .data, envir)
  condition[is.na(condition)] = FALSE
  .data[condition, ] <- .data[condition, ] %>% mutate(...)
  .data
}

death_page1<-read_html("https://en.wikipedia.org/wiki/List_of_deaths_in_rock_and_roll")
write_html(death_page1,file="death_page1.html")
death_page2<-read_html("https://en.wikipedia.org/wiki/List_of_2010s_deaths_in_rock_and_roll")
write_html(death_page2,file="death_page2.html")

```
`xml2` is a very powerful package but one thing I learned is that it works with pointers to the data rather than the actual data. C programmers and old geezers like me will be familiar with this.  I remember pop and push and stacks and all that stuff from the old days.  R generally doesnt pass values "by reference." It passes "by value." That's why when you modify data in the scope of a function it doesn't affect the value of the data outside unless you assign it with `return <data>`.  Using pointers means modifications to html data happen without an explicit assigment.

Consider a trival example:
```{r, eval=FALSE}
#ususal R behavior
my_function<- function(x){return (x+1)}
data=3
#this doesn't change data
my_function(data)
data
#[1] 3
#this does
data<-my_function(data)
data
#[1] 4
```
If we were passing values "by reference" `my_function(data)` would change `data`.  That's how `xml2` works.

We use this behaviour to combine them the tables in the two Wikipedia articles into one html page by extracting the tables in the second wiki article and making them xml siblings of the tables in the first.
```{r}
#join pre-2010 to post 2010
death_page<-death_page1
death_page_child<-death_page1 %>% xml_children() %>% .[2]
death_page2_child<-death_page2 %>% xml_children() %>% .[2]
#create one big web page by adding all the first level children from the second
#page to the first.
xml_add_sibling(death_page_child,death_page2_child)
write_html(death_page,file="death_page.html")

```
Unfortunately, as is often the case, the tables are not as clean as we might like. 

Here's a data wrastlin' puzzle.  The artist and the band name or names share a single cell.  This is not a problem for the anonymous summary stats we will present here but I am doing another analysis where I look at radio station playlist patterns do detect deaths.  Here we need to flag the event by band or artist, however it appears.

Parsing HTML is a dark art and I would not rise to the level of sorcerer's apprentice.  The clue that will let us separate the two (or more) identifiers is that the band is encased in a `<small><\small>` tag.  Extracting the just the text from the cell concatenates the two items without a separator.  The `XML2` functions won't help this noob here.  We would like to break the person and the band into separate columns and we need to search/replace the file as raw text to do it. So instead of `<td>Person<small>Band,Band<\small><\td>` we want to have `<td>Person,Band,band***<\td>`.  This way we can separate out band names later.


```{r}
#Crude hack follows
# read it in as a raw text file and edit the tags
# to break the artist name and band names into comma-separated list
# by replacing '<small>' with ','.
death_page_text<-read_file("death_page.html")
death_page_text<- gsub( "<small>", ", ", death_page_text )
death_page_text<- gsub( "</small>", "", death_page_text )
write_file(death_page_text,"death_page2.html")

```
A further wrinkle is some of the age-at-death numbers are given as a range like "45-46" which causes `html_table` to create a `character  ` column while it will othwise be of type `numeric`.  We want to use `bind_rows` to combine all the web page tables into one data frame but it will break on the type conflict.  Let's arbitrarily take the lowest number in age range before binding.  We can do this as part of the table extraction process.

```{r}
# omit first five tables
deaths_raw<-read_html("death_page2.html") %>% 
  html_nodes("table") %>% 
  .[5:length(.)] %>% 
  html_table(fill=TRUE) %>%
  lapply(function(x){mutate(x,Age=as.integer(str_extract(as.character(Age),"[0-9]+")))}) %>% 
  bind_rows() %>% 
  as_data_frame() %>% 
  {.}

deaths_raw
```


Almost done.  Separate out the list of name and bands into, at most, four bands. Turn the date string into a POSIX-style date. Replace the empty causes with "Not Specified." Finally, strip the footnote numbers out of the file.

```{r warning=FALSE}
#take at most three band names.
deaths<-deaths_raw %>% 
  separate(Name,into=c("Name","band1","band2","band3","band4"),sep=",",extra="drop")

deaths<-deaths %>% 
  mutate(Date=parse_date(Date,"%B %d, %Y")) %>% 
  filter(!is.na(Date))

#remove footnotes and change empty causes to "Not Specified"

deaths<-deaths %>% mutate(`Cause of death`=str_replace(`Cause of death`,"\\[[0-9,]+\\]",""))
deaths<-deaths %>% mutate_cond(is.na(`Cause of death`),`Cause of death`="Not Specified")
deaths<-deaths %>% mutate_cond(`Cause of death`=="",`Cause of death`="Not Specified")
```
#Number of reports

Now we have a clean table.  Before going further we should note that reports are growing over time.  No great surprises here but this says something about the age of Wikipedia, the grownig popularity of Wikipedia and the age of Rock and Roll.  It does not say anything about the business getting more risky.

```{r}
deaths<-deaths %>% mutate(Year=year(Date))

deaths %>%  
  group_by(Year) %>% 
  summarise(NumEntries=n()) %>%
  ggplot(aes(Year,NumEntries))+geom_col()

```
# Common causes of Death

```{r}
#what are common causes of death
cause_table<-deaths %>% 
  group_by(`Cause of death`) %>% 
  summarize(Cause=n()) %>% 
  arrange(desc(Cause))

cause_table
```
Looking through the table we see that many causes can be generalized.  Let's aggregate a bit. We are making some choices here.  For instance, I call any cause containing the words "heart" or "cardiac" as "heart disease."  I count alcohol as a drug.
```{r}
#add a new column "general cause"
deaths<-deaths %>% mutate(General_Cause=`Cause of death`)

deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "accident|fall|hit|crash"),General_Cause="Accident")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "drug|overdose|alcohol"),General_Cause="Drugs")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),"shot|shoot|murder|stab|gun|knife"),
              General_Cause="Murdered")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "heart|cardi|coronary"),General_Cause="Heart Disease")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),"aids|hiv"),General_Cause="AIDS")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "diabetes|diabetic"),General_Cause="Diabetes")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "pneumonia|emphysema"),General_Cause="Lung Disease")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "cirrhosis|neph|liver"),General_Cause="Liver Disease")

deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "stroke"),General_Cause="Stroke")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),
                         "alzh"),General_Cause="Alzheimers")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),"suicide"),General_Cause="Suicide")

#Cancer is last because iting other organs and cancer counts as cancer.
#-omas other than "stomach" and "coma" are cancer
deaths<-deaths %>% 
  mutate_cond(str_detect(`Cause of death`,"oma") & 
                !str_detect(`Cause of death`,"tomach|coma"),
              General_Cause="Cancer")
deaths<-deaths %>% 
  mutate_cond(str_detect(tolower(`Cause of death`),"cancer|tumor"),General_Cause="Cancer")

cause_table<-deaths %>% 
  count(General_Cause) %>% 
  arrange(desc(n)) %>% 
  rename(Rockers=n)

cause_table<-cause_table %>% mutate(General_Cause= as_factor(General_Cause))
cause_table
```

```{r}
#plot, leaving out "not specified"
gg<-cause_table[1:11,]  %>% 
  filter(General_Cause != "Not Specified") %>%
  ggplot(aes(General_Cause,Rockers))+geom_col()
gg<-gg+coord_flip()
gg
```
Now we have a decent picture of how rock stars die.  Mostly from the same things that kill all of us. Heart disease and Cancer are the leading causes of death in US, followed by lung disease and accidents according to https://www.cdc.gov/nchs/fastats/deaths.htm.

Heart disease: 633,842
Cancer: 595,930
Chronic lower respiratory diseases: 155,041
Accidents (unintentional injuries): 146,571
Stroke (cerebrovascular diseases): 140,323
Alzheimerâ€™s disease: 110,561
Diabetes: 79,535
Influenza and Pneumonia: 57,062
Liver disease: 49,959
Suicide: 44,193
Murder: 15,696 (https://ucr.fbi.gov/crime-in-the-u.s/2015/crime-in-the-u.s.-2015/tables/table-4)
Drug overdoses: 53,000 (2015,https://www.drugabuse.gov/related-topics/trends-statistics/overdose-death-rates)
Alcohol Poisoning:2,200 (https://www.cdc.gov/vitalsigns/alcohol-poisoning-deaths/index.html)

Drug overdoses may count as "accidents" at the CDC.  I don't separate out Pneumonia from chronic lung problems. Alzheimer's is a big killer, nationally but is only 21st on the list of rock deaths.  Perhaps it is underreported or was recognized as a distinct cause of death only recently.

There are some interesting causes in this list.  Three electrocutions, two by guitar and one my microphone. They all happened in England in the early 70s.  Presumably the electrical codes have been tightned up a bit since.  Three people are listed who choked on their own vomit. That's all? Consider the hapless Steve Took of T Rex, who died from choking on a cocktail cherry.  That's why I always take my Manhattans with a lemon twist instead.

While the big killers are the same for both populations, is there evidence that rockers "live fast?"  Yes, it turns out.

```{r}

us_deaths<-data_frame(General_Cause=as_factor(c('Heart Disease','Cancer',
                                      'Lung Disease','Accident','Stroke',
                                      'Alzheimers','Diabetes','Liver Disease',
                                      'Suicide','Murdered')),
                      US=c(633842,595930,212103,146571,140323,110561,79535,49959,44193,15696))

# we assume the CDC calls drug overdoses an accident so we will too.
comp_deaths<-cause_table %>% 
  mutate_cond(General_Cause=="Drugs",General_Cause="Accident") %>% 
  group_by(General_Cause) %>% 
  summarise(Rockers=sum(Rockers)) %>% 
  right_join(us_deaths) %>%
  mutate(General_Cause=as_factor(General_Cause))
  

gg<-comp_deaths %>% ggplot(aes(US,Rockers))+geom_point()
gg<-gg+  geom_text_repel(label=comp_deaths$General_Cause)
gg<-gg+geom_smooth(method="lm",formula= y~0+x,se=FALSE)
gg<-gg+labs(title="Rock Stars are Almost Like the Rest of US",caption="Sources: Wikipedia and CDC",
y='Rock Music Deaths (1950-Present)',x='US Deaths (2015)')
gg
```
This shows the preponderance of Rock musician deaths relative to the broader US population.  We can see that suicide, accidents and murder account for more relative deaths than they do in the broader population.

We've <grin>scientifically proven</grin> that rock stars "live fast."  Do they die young?  Life expectancies have grown over the years so taking an aggregate average age at death won't be comprable to current US life expectancy.  To get a comparison let's pull the data from the `gapminder` package.  This shows life expectancy at birth as opposed to average age at death, which is what we have now, so we have to get a bit tricky to make the numbers comparable.  Our year at births is much earlier than the gapminder set covers so we need to extrapolate the data, as well.

```{r}
#add birth year column
deaths<-deaths %>% mutate(birth_year=year(Date)-Age)

#create extrapolation of gapminder life expectancy.
life_exp<-gapminder %>% 
  filter(country=="United States") %>% 
  select(year,lifeExp) %>% rename(birth_year=year) %>% 
  complete(birth_year=min(deaths$birth_year):year(Sys.Date())) %>% 
  {.}
p<-lm(life_exp$lifeExp~life_exp$birth_year)
life_exp$US<-predict(p,life_exp)

#how well does this fit the data?
life_exp %>% ggplot(aes(birth_year,US))+geom_line()+geom_point(aes(y=lifeExp))

```
We see that the gapminder data is pretty linear so we should be okay to extrapolate.  That said, we are going way beyond the observed range.  Our sample sizes are pretty small at the far end of the range so any conclusions would have to be taken with a huge grain of salt anyway.  Still, lets plunge on!


deaths<-deaths %>% mutate(birth_year=year(Date)-Age)

death_age<-deaths %>% 
  group_by(Year) %>% 
  summarise(Rockers=mean(Age))

death_age2<-gapminder %>% filter(country=="United States") %>% 
  select(year,lifeExp) %>% rename(Year=year,US=lifeExp) %>% 
  right_join(death_age) %>% 
  mutate(US=na.approx(US,rule=2,na.rm = FALSE)) %>% 
  {.}

approx(death_age2$Year,death_age2$US,rule=1)

%>%
  ggplot(aes(Year,mean_age))+geom_smooth()

1900 2,3 . . . . . . . . . . . . . . . . 47.3 46.3 48.3 47.6 46.6 48.7 33.0 32.5 33.5
1950 3 . . . . . . . . . . . . . . . . . 68.2 65.6 71.1 69.1 66.5 72.2 60.8 59.1 62.9
1960 3 . . . . . . . . . . . . . . . . . 69.7 66.6 73.1 70.6 67.4 74.1 63.6 61.1 66.3
1970 . . . . . . . . . . . . . . . . . 70.8 67.1 74.7 71.7 68.0 75.6 64.1 60.0 68.3
1975 . . . . . . . . . . . . . . . . . 72.6 68.8 76.6 73.4 69.5 77.3 66.8 62.4 71.3
1980 . . . . . . . . . . . . . . . . . 73.7 70.0 77.4 74.4 70.7 78.1 68.1 63.8 72.5
1990 . . . . . . . . . . . . . . . . . 75.4 71.8 78.8 76.1 72.7 79.4 69.1 64.5 73.6
1995 . . . . . . . . . . . . . . . . . 75.8 72.5 78.9 76.5 73.4 79.6 69.6 65.2 73.9
2000 . . . . . . . . . . . . . . . . . 76.8 74.1 79.3 77.3 74.7 79.9 71.8 68.2 75.1
2001 . . . . . . . . . . . . . . . . . 77.0 74.3 79.5 77.5 74.9 80.0 72.0 68.5 75.3
2002 . . . . . . . . . . . . . . . . . 77.0 74.4 79.6 77.5 74.9 80.1 72.2 68.7 75.4
2003 . . . . . . . . . . . . . . . . . 77.2 74.5 79.7 77.7 75.1 80.2 72.4 68.9 75.7
2004 . . . . . . . . . . . . . . . . . 77.6 75.0 80.1 78.1 75.5 80.5 72.9 69.4 76.1
2005 . . . . . . . . . . . . . . . . . 77.6 75.0 80.1 78.0 75.5 80.5 73.0 69.5 76.2
2006 . . . . . . . . . . . . . . . . . 77.8 75.2 80.3 78.3 75.8 80.7 73.4 69.9 76.7
2007 . . . . . . . . . . . . . . . . . 78.1 75.5 80.6 78.5 76.0 80.9 73.8 70.3 77.0
2008 . . . . . . . . . . . . . . . . . 78.2 75.6 80.6 78.5 76.1 80.9 74.3 70.9 77.3
2009 . . . . . . . . . . . . . . . . . 78.5 76.0 80.9 78.8 76.4 81.2 74.7 71.4 77.7
2010 . . . . . . . . . . . . . . . . . 78.7 76.2 81.0 78.9 76.5 81.3 75.1 71.8 78.0
2011 . . . . . . . . . . . . . . . . . 78.7 76.3 81.1 79.0 76.6 81.3 75.3 72.2 78.2
2012 . . . . . . . . . . . . . . . . . 78.8 76.4 81.2 79.1 76.7 81.4 75.5 72.3 78.4
2013 4 . . . . . . . . . . . . . . . . . 78.8 76.4 81.2 79.0 76.7 81.4 75.5 72.3 78.4
2014 4 . . . . . . . . . . . . . . . . . 78.9 76.5 81.3 79.1 76.7 81.4 75.6 72.5 78.5
2015 4 . . . . . . . . . . . . . . . . . 78.8 76.3 81.2 79.0 76.6 81.3 75.5 72.2 78.5 