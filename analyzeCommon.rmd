---
title: "WFMU DJ Artists most widely played"
output: html_notebook
---
Analyze all artists ever played by each WFMU DJ to find commonality.  wfmu.org provides a list of unique artists for every DJ. This is of limited utility because superstars like the Beatles have probably been played at least once by every DJ.  These are the most widely played artists.  Frequency of play would be more interesting and let us learn more about the similarity among DJs.  Scraping playlists is more involved however and is left for a future project.

```{r}
#analyze list of artists to find DJ similarity

library(tidyverse)
# library(devtools)
# #install_github('sinhrks/ggfortify')
library(ggplot2)
library(stringr)
#library(tm)
library(dplyr)
# #library(ggfortify)
library(RColorBrewer)
library(wordcloud)
library(SnowballC)
library(tm)
# library(igraph)
# library(cluster)
# library(reshape2)
# library(proxy)
# library(Matrix)
# library(hashmap)
```

Set up functions to clean data scraped from wfmu.org.  Data scrape has been done and saved as "allDJArtists.RData"

```{r}

#-----------------------------------------------------------------------
cleanUpArtists<- function(allDJArtists) {
  allDJArtists$artistRaw<-allDJArtists$artist
# one artist is all punctuation so give !!! special treatment
  allDJArtists$artist<-str_replace(allDJArtists$artist,"!!!","chkchkchk")
  # now change some common punctuation to space
  print("Stripping Punctuation")

  allDJArtists$artist<-str_replace_all(allDJArtists$artist,"\\&"," ")
  
  allDJArtists$artist<-str_to_lower(allDJArtists$artist)
  # I choose to strip out the stuff below though dealing with it might get better analysis
  #remove any text in parentheses
  print("Stripping filler words")
  # get rid of anything between parenthesis
  #tricky regex to handle cases of multiple parentheticals in one artist
  allDJArtists$artist<-str_replace_all(allDJArtists$artist,"(\\([^(]+\\))","")
  # remove 'featuring' or 'with' artists
  # I chose not to remove "Versus" because that is a band name
  allDJArtists$artist<-str_replace_all(allDJArtists$artist,"(feat |featuring |with |vs |vs\\.).+","")
  # get rid of 'live' identifier
  allDJArtists$artist<-str_replace_all(allDJArtists$artist,"(live @ |live on|@).+","")

  #now get rid of remaining non-word characters except space

  allDJArtists$artist<-str_replace_all(allDJArtists$artist,"[^a-z^ ^0-9]","")
  
  
  # get rid of 'interview'
  allDJArtists$artist<-str_replace_all(allDJArtists$artist,"(interview w|interview)","")
  
  # get rid of unspecified artists
  allDJArtists$artist<-str_replace_all(allDJArtists$artist,"unknown artist(s| )|unknown","")
  allDJArtists$artist<-str_replace_all(allDJArtists$artist,"various artists|various","")
  
  #get rid of the marathon finale
  allDJArtists<-allDJArtists%>%filter(!str_detect(artist,"hoof[a-zA-Z ]+sinfonia"))
  
  #make "new york" one word.  Lots of bands start with the term
  allDJArtists$artist<-str_replace_all(allDJArtists$artist,"new york","newyork")
  
  #make "x ray" one word. hopefully we've stripped out the dash already.Lots of bands start with the term
  allDJArtists$artist<-str_replace_all(allDJArtists$artist,"x ray","xray")
  
  #now some connecting words that might be spelled/used variantly
  allDJArtists$artist<-str_replace_all(allDJArtists$artist,"and | of | the "," ")

  #and leading "the"
  allDJArtists$artist<-str_replace_all(allDJArtists$artist,"^the "," ")
  # strip leading/trailing whitespace
  allDJArtists$artist<-str_trim(allDJArtists$artist)

  #did we create any null entries
  allDJArtists<-filter(allDJArtists,artist!="")
  allDJArtists<-filter(allDJArtists,artist!="artist")
  
  return(allDJArtists)
  
}
#-----------------------------------------------------------------------------
combineArtistWords <- function(allDJArtists,numWords){
  # we replaced all punctuation with spaces
  #maybe strip spaces and combine all artist Words
  #combine first two words
  print("Trying to make sense of artist names")
  #does this break if numWords> number of words?
  t<-str_split_fixed(allDJArtists$artist,pattern="[ ]+",n=numWords+1)[,1:numWords]
  
  allDJArtists$artistToken<-apply(t,MARGIN=1,FUN=paste,collapse="")

    # There are a dozen ways Andy Breckman can misspell "Bruce Springsteen."
  artistTokens%>%mutate(artistToken=replace(artistToken,str_detect(artistToken,'brucesp'),"brucespringsteen"))->artistTokens

  #now that tokens are created extract unique ones for each dj so mulitples
  # don't occur
  # the zillion flavors of "Sun Ra..." will show up for each DJ only once
  print("Create list of unique artist names for each DJ")
  artistTokens<-allDJArtists%>%select(DJ,artistToken)%>%group_by(DJ)%>%distinct(artistToken)

  print("Combining iconic 2-name artists into one name to save space in wordcloud")
  artistTokens$artistToken<-str_replace_all(artistTokens$artistToken,"rollingstones","stones")
  artistTokens$artistToken<-str_replace_all(artistTokens$artistToken,"enniomorricone","morricone") #only on WFMU!
  artistTokens$artistToken<-str_replace_all(artistTokens$artistToken,"davidbowie","bowie")
  artistTokens$artistToken<-str_replace_all(artistTokens$artistToken,"bobdylan","dylan")
  #rm(t)
  return(artistTokens)
}
#-------------------------------------------------------------------------------------
addArtistCount<- function(DJKey,artistTokens) {
  DJKey<-artistTokens%>%summarise(count=n())%>%inner_join(DJKey)%>%arrange(desc(count))
  names(DJKey)<-c("DJ","artistCount","ShowName","onMic")
  # make DJs a factor
  DJKey$ShowName<-factor(DJKey$ShowName,as.character(DJKey$ShowName))
  DJKey$DJ<-factor(DJKey$DJ,as.character(DJKey$DJ))
  return(DJKey)
}
```

Load data
```{r}
load("allDJArtists.RData")
load("DJKey.RData")
# #save(DJKey,file="DJKey.RData")
```
Munge data
```{r, message=FALSE}
# 
allDJArtists<-as_tibble(allDJArtists)
allDJArtists<-cleanUpArtists(allDJArtists)


# #combine first numWords in artist name into a single token.
# Artist names of more than two words are reduced to a single token
# of the first two words joined so "Joe Blow featuring Sally Swell"
# and "Joe Blow and the Big Wind" will both become "joeblow"
artistTokens<-combineArtistWords(allDJArtists,numWords=2)
# #get rid of DJs with less than 100 artists, ever.  Probably not a music show
DJKey<-filter(DJKey,artistCount>100)
artistTokens<-semi_join(artistTokens,DJKey)
#regroup
artistTokens<-artistTokens%>%group_by(DJ)
# 
save(artistTokens,file="artistTokens.RData")
load("artistTokens.RData")

# #combine words into one document per DJ
# djDocs<-as_tibble(combineAllArtists())
# save(djDocs,file="djDocs.RData")
# load("djDocs.RData")
 

```


Make a word cloud of the most widely played artists
```{r, warning=FALSE}

# New MAIN

artistTokens%>%group_by(artistToken)%>%summarize(count=n())%>%arrange(desc(count)) ->artist_count
artist_count$artistToken<-as.factor(artist_count$artistToken)
#scalefactor magnifies differences for wordcloud
scaleFactor=3
maxWords = 200
wordcloud(words = artist_count$artistToken, freq =                             artist_count$count^scaleFactor,max.words=maxWords,                   random.order=FALSE,rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"),scale = c(3,.3))

```
```{r}
#make sure bars are in height order
artist_count$artistToken<-reorder(artist_count$artistToken,artist_count$count)
gg<-ggplot(artist_count[1:20,],aes(x=artistToken,y=count/nrow(DJKey)*100))+geom_col()
gg<-gg+labs(title='Most Widely Played Artists on WFMU',
            y='Pct of DJs Who Have Played Artist at Least Once',
            x= 'Artist')
gg<-gg+coord_flip()
print(gg)
```
While we are going crazy with word clouds, what are the most widely played artists with the word "love" in the artist name?
```{r}
temp<-allDJArtists$artist%>%str_split(' ')%>%unlist()%>%table()%>%as.data.frame()%>%arrange(desc(Freq))
names(temp)<-c('band_word','count')


lovebands <-artist_count%>%filter(str_detect(artistToken,'love'))
wordcloud(words = lovebands$artistToken, freq =                                lovebands$count,max.words=maxWords,                                  random.order=FALSE,rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"),scale = c(3,.3))

```

